/*
 * Space Invaders game
 * Original author: Dave Kerr + contributors - https://github.com/dwmkerr/spaceinvaders
 * Modifications by Łukasz Wójcik - https://www.lukaszwojcik.net
 */
function Starfield(){this.fps=30,this.canvas=null,this.width=0,this.width=0,this.minVelocity=15,this.maxVelocity=30,this.stars=100,this.intervalId=0}function Star(t,e,i,s){this.x=t,this.y=e,this.size=i,this.velocity=s}Starfield.prototype.initialise=function(t){var e=this;this.containerDiv=t,e.width=window.innerWidth,e.height=window.innerHeight,window.onresize=function(t){e.width=window.innerWidth,e.height=window.innerHeight,e.canvas.width=e.width,e.canvas.height=e.height,e.draw()};var i=document.createElement("canvas");t.appendChild(i),this.canvas=i,this.canvas.width=this.width,this.canvas.height=this.height},Starfield.prototype.start=function(){for(var t=[],e=0;e<this.stars;e++)t[e]=new Star(Math.random()*this.width,Math.random()*this.height,3*Math.random()+1,Math.random()*(this.maxVelocity-this.minVelocity)+this.minVelocity);this.stars=t;var i=this;this.intervalId=setInterval(function(){i.update(),i.draw()},1e3/this.fps)},Starfield.prototype.stop=function(){clearInterval(this.intervalId)},Starfield.prototype.update=function(){for(var t=1/this.fps,e=0;e<this.stars.length;e++){var i=this.stars[e];i.y+=t*i.velocity,i.y>this.height&&(this.stars[e]=new Star(Math.random()*this.width,0,3*Math.random()+1,Math.random()*(this.maxVelocity-this.minVelocity)+this.minVelocity))}},Starfield.prototype.draw=function(){var t=this.canvas.getContext("2d");t.fillStyle="#000000",t.fillRect(0,0,this.width,this.height),t.fillStyle="#999999";for(var e=0;e<this.stars.length;e++){var i=this.stars[e];t.fillRect(i.x,i.y,i.size,i.size)}};var KEY_LEFT=37,KEY_RIGHT=39,KEY_SPACE=32,GAME_FONT="'Nokia Cellphone FC'";const gameScreenWidth=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;function SIGame(){this.config={bombRate:.05,bombMinVelocity:50,bombMaxVelocity:50,invaderInitialVelocity:25,invaderAcceleration:0,invaderDropDistance:20,rocketVelocity:120,rocketMaxFireRate:2,gameWidth:400,gameHeight:300,fps:50,debugMode:!1,invaderRanks:5,invaderFiles:10,shipSpeed:120,levelDifficultyMultiplier:.2,pointsPerInvader:5,limitLevelIncrease:25},this.lives=3,this.width=0,this.height=0,this.gameBounds={left:0,top:0,right:0,bottom:0},this.intervalId=0,this.score=0,this.level=1,this.stateStack=[],this.pressedKeys={},this.gameCanvas=null,this.previousX=0}function GameLoop(t){var e=t.currentState();if(e){var i=1/t.config.fps,s=this.gameCanvas.getContext("2d");e.update&&e.update(t,i),e.draw&&e.draw(t,i,s)}}function WelcomeState(){}function GameOverState(){}function PlayState(t,e){this.config=t,this.level=e,this.invaderCurrentVelocity=10,this.invaderCurrentDropDistance=0,this.invadersAreDropping=!1,this.lastRocketTime=null,this.ship=null,this.invaders=[],this.rockets=[],this.bombs=[]}function PauseState(){}function LevelIntroState(t){this.level=t,this.countdownMessage="3"}function Ship(t,e){this.x=t,this.y=e,this.width=20,this.height=16}function Rocket(t,e,i){this.x=t,this.y=e,this.velocity=i}function Bomb(t,e,i){this.x=t,this.y=e,this.velocity=i}function Invader(t,e,i,s,h){this.x=t,this.y=e,this.rank=i,this.file=s,this.type=h,this.width=18,this.height=14}function GameState(t,e,i,s,h,n){this.updateProc=t,this.drawProc=e,this.keyDown=i,this.keyUp=s,this.enter=h,this.leave=n}SIGame.prototype.initialise=function(t){this.gameCanvas=t,this.width=t.width,this.height=t.height,this.gameBounds={left:t.width/2-this.config.gameWidth/2,right:t.width/2+this.config.gameWidth/2,top:t.height/2-this.config.gameHeight/2,bottom:t.height/2+this.config.gameHeight/2}},SIGame.prototype.moveToState=function(t){this.currentState()&&this.currentState().leave&&(this.currentState().leave(game),this.stateStack.pop()),t.enter&&t.enter(game),this.stateStack.pop(),this.stateStack.push(t)},SIGame.prototype.start=function(){this.moveToState(new WelcomeState),this.lives=3,this.config.debugMode=/debug=true/.test(window.location.href);var t=this;this.intervalId=setInterval(function(){GameLoop(t)},1e3/this.config.fps)},SIGame.prototype.currentState=function(){return this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null},SIGame.prototype.pushState=function(t){t.enter&&t.enter(game),this.stateStack.push(t)},SIGame.prototype.popState=function(){this.currentState()&&(this.currentState().leave&&this.currentState().leave(game),this.stateStack.pop())},SIGame.prototype.stop=function(){clearInterval(this.intervalId)},SIGame.prototype.keyDown=function(t){this.pressedKeys[t]=!0,this.currentState()&&this.currentState().keyDown&&this.currentState().keyDown(this,t)},SIGame.prototype.touchstart=function(t){this.currentState()&&this.currentState().keyDown&&this.currentState().keyDown(this,KEY_SPACE)},SIGame.prototype.touchend=function(t){delete this.pressedKeys[KEY_RIGHT],delete this.pressedKeys[KEY_LEFT]},SIGame.prototype.touchmove=function(t){var e=t.changedTouches[0].pageX;this.previousX>0&&(e>this.previousX?(delete this.pressedKeys[KEY_LEFT],this.pressedKeys[KEY_RIGHT]=!0):(delete this.pressedKeys[KEY_RIGHT],this.pressedKeys[KEY_LEFT]=!0)),this.previousX=e},SIGame.prototype.keyUp=function(t){delete this.pressedKeys[t],this.currentState()&&this.currentState().keyUp&&this.currentState().keyUp(this,t)},WelcomeState.prototype.update=function(t,e){},WelcomeState.prototype.draw=function(t,e,i){i.clearRect(0,0,t.width,t.height),i.font="30px "+GAME_FONT,i.fillStyle="#ffffff",i.textBaseline="middle",i.textAlign="center",i.fillText("Space Invaders",t.width/2,t.height/2-40),i.font="16px "+GAME_FONT,i.fillText("Press 'Space' or tap to start.",t.width/2,t.height/2)},WelcomeState.prototype.keyDown=function(t,e){e==KEY_SPACE&&(t.level=1,t.score=0,t.lives=3,t.moveToState(new LevelIntroState(t.level)))},GameOverState.prototype.update=function(t,e){},GameOverState.prototype.draw=function(t,e,i){i.clearRect(0,0,t.width,t.height),i.font="30px "+GAME_FONT,i.fillStyle="#ffffff",i.textBaseline="center",i.textAlign="center",i.fillText("Game Over!",t.width/2,t.height/2-40),i.font="16px "+GAME_FONT,i.fillText("You scored "+t.score+" and got to level "+t.level,t.width/2,t.height/2),i.font="16px "+GAME_FONT,i.fillText("Press 'Space' or tap to play again.",t.width/2,t.height/2+40)},GameOverState.prototype.keyDown=function(t,e){e==KEY_SPACE&&(t.lives=3,t.score=0,t.level=1,t.moveToState(new LevelIntroState(1)))},PlayState.prototype.enter=function(t){this.ship=new Ship(t.width/2,t.gameBounds.bottom),this.invaderCurrentVelocity=10,this.invaderCurrentDropDistance=0,this.invadersAreDropping=!1;var e=this.level*this.config.levelDifficultyMultiplier,i=this.level<this.config.limitLevelIncrease?this.level:this.config.limitLevelIncrease;this.shipSpeed=this.config.shipSpeed,this.invaderInitialVelocity=this.config.invaderInitialVelocity+e*this.config.invaderInitialVelocity*1.5,this.bombRate=this.config.bombRate+e*this.config.bombRate,this.bombMinVelocity=this.config.bombMinVelocity+e*this.config.bombMinVelocity,this.bombMaxVelocity=this.config.bombMaxVelocity+e*this.config.bombMaxVelocity,this.rocketMaxFireRate=this.config.rocketMaxFireRate+.4*i;for(var s=this.config.invaderRanks+.1*i,h=this.config.invaderFiles+.2*i,n=[],o=0;o<s;o++)for(var a=0;a<h;a++)n.push(new Invader(t.width/2+200*(h/2-a)/h,t.gameBounds.top+20*o,o,a,"Invader"));this.invaders=n,this.invaderCurrentVelocity=this.invaderInitialVelocity,this.invaderVelocity={x:-this.invaderInitialVelocity,y:0},this.invaderNextVelocity=null},PlayState.prototype.update=function(t,e){t.pressedKeys[KEY_LEFT]&&(this.ship.x-=this.shipSpeed*e),t.pressedKeys[KEY_RIGHT]&&(this.ship.x+=this.shipSpeed*e),t.pressedKeys[KEY_SPACE]&&this.fireRocket(),this.ship.x<t.gameBounds.left&&(this.ship.x=t.gameBounds.left),this.ship.x>t.gameBounds.right&&(this.ship.x=t.gameBounds.right);for(var i=0;i<this.bombs.length;i++){(f=this.bombs[i]).y+=e*f.velocity,f.y>this.height&&this.bombs.splice(i--,1)}for(i=0;i<this.rockets.length;i++){(d=this.rockets[i]).y-=e*d.velocity,d.y<0&&this.rockets.splice(i--,1)}var s=!1,h=!1,n=!1;for(i=0;i<this.invaders.length;i++){var o=(r=this.invaders[i]).x+this.invaderVelocity.x*e,a=r.y+this.invaderVelocity.y*e;0==s&&o<t.gameBounds.left?s=!0:0==h&&o>t.gameBounds.right?h=!0:0==n&&a>t.gameBounds.bottom&&(n=!0),s||h||n||(r.x=o,r.y=a)}for(this.invadersAreDropping&&(this.invaderCurrentDropDistance+=this.invaderVelocity.y*e,this.invaderCurrentDropDistance>=this.config.invaderDropDistance&&(this.invadersAreDropping=!1,this.invaderVelocity=this.invaderNextVelocity,this.invaderCurrentDropDistance=0)),s&&(this.invaderCurrentVelocity+=this.config.invaderAcceleration,this.invaderVelocity={x:0,y:this.invaderCurrentVelocity},this.invadersAreDropping=!0,this.invaderNextVelocity={x:this.invaderCurrentVelocity,y:0}),h&&(this.invaderCurrentVelocity+=this.config.invaderAcceleration,this.invaderVelocity={x:0,y:this.invaderCurrentVelocity},this.invadersAreDropping=!0,this.invaderNextVelocity={x:-this.invaderCurrentVelocity,y:0}),n&&(t.lives=0),i=0;i<this.invaders.length;i++){for(var r=this.invaders[i],l=!1,c=0;c<this.rockets.length;c++){var d;if((d=this.rockets[c]).x>=r.x-r.width/2&&d.x<=r.x+r.width/2&&d.y>=r.y-r.height/2&&d.y<=r.y+r.height/2){this.rockets.splice(c--,1),l=!0,t.score+=this.config.pointsPerInvader;break}}l&&this.invaders.splice(i--,1)}var p={};for(i=0;i<this.invaders.length;i++){(!p[(r=this.invaders[i]).file]||p[r.file].rank<r.rank)&&(p[r.file]=r)}for(i=0;i<this.config.invaderFiles;i++){if(r=p[i])this.bombRate*e>Math.random()&&this.bombs.push(new Bomb(r.x,r.y+r.height/2,this.bombMinVelocity+Math.random()*(this.bombMaxVelocity-this.bombMinVelocity)))}for(i=0;i<this.bombs.length;i++){var f;(f=this.bombs[i]).x>=this.ship.x-this.ship.width/2&&f.x<=this.ship.x+this.ship.width/2&&f.y>=this.ship.y-this.ship.height/2&&f.y<=this.ship.y+this.ship.height/2&&(this.bombs.splice(i--,1),t.lives--)}for(i=0;i<this.invaders.length;i++){(r=this.invaders[i]).x+r.width/2>this.ship.x-this.ship.width/2&&r.x-r.width/2<this.ship.x+this.ship.width/2&&r.y+r.height/2>this.ship.y-this.ship.height/2&&r.y-r.height/2<this.ship.y+this.ship.height/2&&(t.lives=0)}t.lives<=0&&t.moveToState(new GameOverState),0===this.invaders.length&&(t.score+=50*this.level,t.level+=1,t.moveToState(new LevelIntroState(t.level)))},PlayState.prototype.draw=function(t,e,i){i.clearRect(0,0,t.width,t.height),i.fillStyle="#FFFFFF",i.fillRect(this.ship.x-this.ship.width/2,this.ship.y-this.ship.height/2,this.ship.width,this.ship.height),i.fillStyle="#006600";for(var s=0;s<this.invaders.length;s++){var h=this.invaders[s];i.fillRect(h.x-h.width/2,h.y-h.height/2,h.width,h.height)}i.fillStyle="#ff5555";for(s=0;s<this.bombs.length;s++){var n=this.bombs[s];i.fillRect(n.x-2,n.y-2,4,4)}i.fillStyle="#ff0000";for(s=0;s<this.rockets.length;s++){var o=this.rockets[s];i.fillRect(o.x,o.y-2,2,10)}var a=t.gameBounds.bottom+(t.height-t.gameBounds.bottom)/2+7;i.font="14px "+GAME_FONT,i.fillStyle="#ffffff";var r="Lives: "+t.lives;i.textAlign="left",i.fillText(r,t.gameBounds.left+10,a),r="Score: "+t.score+" | Level: "+t.level,i.textAlign="right",i.fillText(r,t.gameBounds.right-10,a),this.config.debugMode&&(i.strokeStyle="#ff0000",i.strokeRect(0,0,t.width,t.height),i.strokeRect(t.gameBounds.left,t.gameBounds.top,t.gameBounds.right-t.gameBounds.left,t.gameBounds.bottom-t.gameBounds.top))},PlayState.prototype.keyDown=function(t,e){e==KEY_SPACE&&this.fireRocket(),80==e&&t.pushState(new PauseState)},PlayState.prototype.keyUp=function(t,e){},PlayState.prototype.fireRocket=function(){(null===this.lastRocketTime||(new Date).valueOf()-this.lastRocketTime>1e3/this.rocketMaxFireRate)&&(this.rockets.push(new Rocket(this.ship.x,this.ship.y-12,this.config.rocketVelocity)),this.lastRocketTime=(new Date).valueOf())},PauseState.prototype.keyDown=function(t,e){80==e&&t.popState()},PauseState.prototype.draw=function(t,e,i){i.clearRect(0,0,t.width,t.height),i.font="14px "+GAME_FONT,i.fillStyle="#ffffff",i.textBaseline="middle",i.textAlign="center",i.fillText("Paused",t.width/2,t.height/2)},LevelIntroState.prototype.update=function(t,e){void 0===this.countdown&&(this.countdown=3),this.countdown-=e,this.countdown<2&&(this.countdownMessage="2"),this.countdown<1&&(this.countdownMessage="1"),this.countdown<=0&&t.moveToState(new PlayState(t.config,this.level))},LevelIntroState.prototype.draw=function(t,e,i){i.clearRect(0,0,t.width,t.height),i.font="36px "+GAME_FONT,i.fillStyle="#ffffff",i.textBaseline="middle",i.textAlign="center",i.fillText("Level "+this.level,t.width/2,t.height/2),i.font="24px "+GAME_FONT,i.fillText("Ready in "+this.countdownMessage,t.width/2,t.height/2+36)};